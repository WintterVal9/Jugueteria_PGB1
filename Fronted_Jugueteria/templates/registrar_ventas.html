{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registrar Venta</title>

    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    
    <style>
        /* Estilos para la secci贸n de clientes */
        .clientes-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #ff6f91;
        }
        
        .cliente-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .cliente-card:hover {
            background: #fff0f5;
            border-color: #ff6f91;
            transform: translateY(-2px);
        }
        
        .cliente-card.selected {
            background: #ffe6f0;
            border-color: #ff6f91;
            box-shadow: 0 0 0 2px #ff6f91;
        }
        
        .cliente-info {
            font-size: 0.9rem;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .search-input {
            padding-left: 35px;
        }
    </style>
</head>

<body class="bg-light">

    <header class="text-center bg-white p-4 shadow-sm mb-4">
        <h1>Ь Registro de Ventas</h1>
        <div class="mt-3">
            <a href="/" class="btn btn-secondary"> Inicio</a>  
            <a href="/administracion/productos/" class="btn btn-primary">Ц Administraci贸n</a>
        </div>
    </header>

    <main class="container bg-white p-4 rounded shadow-sm">

        <h2 class="text-center mb-4">Formulario de Nueva Venta</h2>

        <!--  NUEVA SECCIN: B煤squeda y selecci贸n de clientes -->
        <section class="clientes-section">
            <h4 class="mb-3"> Seleccionar Cliente</h4>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="search-box">
                        <span class="search-icon"></span>
                        <input type="text" id="buscarCliente" class="form-control search-input" 
                               placeholder="Buscar cliente por nombre...">
                    </div>
                </div>
                <div class="col-md-6">
                    <button type="button" id="btnVerTodos" class="btn btn-outline-secondary">
                        Ver Todos los Clientes
                    </button>
                </div>
            </div>
            
            <div id="listaClientes" class="row">
                <!-- Los clientes se cargar谩n aqu铆 din谩micamente -->
                <div class="col-12 text-center">
                    <p class="text-muted">Cargando clientes...</p>
                </div>
            </div>
            
            <div class="mt-3">
                <small class="text-muted">
                     Haz clic en un cliente para seleccionarlo autom谩ticamente en el formulario
                </small>
            </div>
        </section>

        <form method="POST" class="form-venta">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label">Cliente:</label>
                <input type="text" id="clienteInput" name="cliente" class="form-control" 
                       placeholder="Nombre del cliente" required readonly
                       style="background-color: #f8f9fa;">
                <small class="text-muted">Este campo se llena autom谩ticamente al seleccionar un cliente</small>
            </div>

            <table class="table table-bordered table-hover mt-4">
                <thead class="table-dark">
                    <tr>
                        <th>Seleccionar</th>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in productos %}
                    <tr>
                        <td class="text-center">
                            <input type="checkbox" name="producto_id" value="{{ p.id }}">
                        </td>
                        <td>{{ p.nombre }}</td>
                        <td>${{ p.precio }}</td>
                        <td>
                            <input type="number" name="cantidad" value="1" min="1" class="form-control" style="width:90px;">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success"> Registrar Venta</button>
                <a href="/administracion/productos/" class="btn btn-danger ms-2">Cancelar</a>
            </div>
        </form>

        {% if messages %}
            <div class="alert alert-info mt-4">
                <ul class="mb-0">
                    {% for message in messages %}
                        <li>{{ message }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </main>

    <footer class="text-center mt-4 p-3 bg-white shadow-sm">
        <p>漏 2025 Sistema de Ventas - Jugueter铆a TeddyBear</p>
    </footer>

    <!-- Script para manejar clientes -->
     <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_BASE = "http://127.0.0.1:8000";
            let clientes = [];
            let clienteSeleccionado = null;
            
            // Elementos del DOM
            const buscarClienteInput = document.getElementById('buscarCliente');
            const btnVerTodos = document.getElementById('btnVerTodos');
            const listaClientes = document.getElementById('listaClientes');
            const clienteInput = document.getElementById('clienteInput');
            
            // Cargar clientes al iniciar
            cargarClientes();
            
            // Evento de b煤squeda
            buscarClienteInput.addEventListener('input', function(e) {
                filtrarClientes(e.target.value);
            });
            
            // Evento ver todos
            btnVerTodos.addEventListener('click', function() {
                buscarClienteInput.value = '';
                mostrarClientes(clientes);
            });
            
            // Funci贸n para cargar clientes desde la API
            async function cargarClientes() {
                try {
                    listaClientes.innerHTML = '<div class="col-12 text-center"><p class="text-muted">Cargando clientes...</p></div>';
                    
                    const response = await fetch(`${API_BASE}/api/clientes/`);
                    if (!response.ok) throw new Error('Error al cargar clientes');
                    
                    const data = await response.json();
                    clientes = Array.isArray(data) ? data : data.clientes || data.data || [];
                    
                    if (clientes.length === 0) {
                        listaClientes.innerHTML = `
                            <div class="col-12 text-center">
                                <p class="text-warning">No hay clientes registrados</p>
                            </div>
                        `;
                        return;
                    }
                    
                    mostrarClientes(clientes);
                    
                } catch (error) {
                    console.error('Error:', error);
                    listaClientes.innerHTML = `
                        <div class="col-12 text-center">
                            <p class="text-danger">Error al cargar clientes: ${error.message}</p>
                        </div>
                    `;
                }
            }
            // Funci贸n para mostrar clientes en cards
            function mostrarClientes(listaClientesMostrar) {
                const listaClientesElement = document.getElementById('listaClientes');
                listaClientesElement.innerHTML = '';
                
                const contenedor = document.createElement('div');
                contenedor.className = 'row';
                
                if (listaClientesMostrar.length === 0) {
                    contenedor.innerHTML = `
                        <div class="col-12 text-center">
                            <p class="text-warning">No se encontraron clientes</p>
                        </div>
                    `;
                    listaClientesElement.appendChild(contenedor);
                    return;
                }
                
                listaClientesMostrar.forEach(cliente => {
                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4 mb-3';
                    
                    col.innerHTML = `
                        <div class="cliente-card ${clienteSeleccionado?.id === cliente.id ? 'selected' : ''}" 
                             data-cliente-id="${cliente.id}" 
                             data-cliente-nombre="${cliente.nombre}">
                            <h6 class="mb-2">${cliente.nombre}</h6>
                            <div class="cliente-info">
                                ${cliente.email ? `<div><strong>Email:</strong> ${cliente.email}</div>` : ''}
                                ${cliente.telefono ? `<div><strong>Tel茅fono:</strong> ${cliente.telefono}</div>` : ''}
                                ${cliente.direccion ? `<div><strong>Direcci贸n:</strong> ${cliente.direccion}</div>` : ''}
                                <div class="mt-2">
                                    <small class="text-success">
                                        <strong>C贸digo:</strong> ${cliente.codigo || 'N/A'}
                                    </small>
                                </div>
                                <div class="mt-1">
                                    <small class="text-info">
                                         Haz clic para ver productos
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Evento click para seleccionar cliente
                    col.querySelector('.cliente-card').addEventListener('click', function() {
                        seleccionarCliente(cliente);
                    });
                    
                    contenedor.appendChild(col);
                });
                
                listaClientesElement.appendChild(contenedor);
            }
            
            // Funci贸n para filtrar clientes
            function filtrarClientes(termino) {
                if (!termino.trim()) {
                    mostrarClientes(clientes);
                    return;
                }
                
                const filtrados = clientes.filter(cliente => 
                    cliente.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                    (cliente.email && cliente.email.toLowerCase().includes(termino.toLowerCase()))
                );
                
                mostrarClientes(filtrados);
            }
            
            // Funci贸n para seleccionar cliente y cargar productos
            function seleccionarCliente(cliente) {
                clienteSeleccionado = cliente;
                clienteInput.value = cliente.nombre;
                
                // Actualizar visualmente la selecci贸n
                document.querySelectorAll('.cliente-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                document.querySelector(`[data-cliente-id="${cliente.id}"]`).classList.add('selected');
                
                //  Cargar productos del cliente en la tabla
                cargarProductosCliente(cliente.id);
                
                // Scroll suave al formulario
                clienteInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Funci贸n autom谩tica para cargar productos del cliente
            function cargarProductosCliente(clienteId) {
                // Todos los productos disponibles de tu base de datos
                const todosProductos = [
                    { id: 1, nombre: "Lego Classic", precio: 120000.00 },
                    { id: 2, nombre: "Robot Interactivo", precio: 250000.00 },
                    { id: 3, nombre: "Mu帽eca Barbie", precio: 80000.00 },
                    { id: 5, nombre: "Carro de Bomberos", precio: 45000.00 },
                    { id: 7, nombre: "Tablet Infantil", precio: 180000.00 },
                    { id: 9, nombre: "Monopoly Cl谩sico", precio: 85000.00 },
                    { id: 10, nombre: "Pista de Carreras", precio: 120000.00 },
                    { id: 36, nombre: "Microscopio Infantil", precio: 95000.00 },
                    { id: 37, nombre: "Drone Control Remoto", precio: 300000.00 }
                ]
                // Clientes espec铆ficos con productos asignados
                const clientesEspeciales = {
                    1: [5],    
                    2: [2, 9,]    
                };
                
                let productosSeleccionados = [];
                
                if (clientesEspeciales[clienteId]) {
                    // Cliente con productos espec铆ficos
                    productosSeleccionados = clientesEspeciales[clienteId]
                        .map(prodId => todosProductos.find(p => p.id === prodId))
                        .filter(p => p);
                } else {
                    // Nuevos clientes - productos aleatorios
                    const shuffled = [...todosProductos].sort(() => 0.5 - Math.random());
                    productosSeleccionados = shuffled.slice(0, Math.floor(Math.random() * 3) + 1); // 1-3 productos
                }
                
                // Agregar cantidad aleatoria
                const productosConCantidad = productosSeleccionados.map(prod => ({
                    ...prod,
                    cantidad: Math.floor(Math.random() * 2) + 1 // 1-2 unidades
                }));
                
                const tbody = document.querySelector('.table tbody');
                
                if (productosConCantidad.length > 0) {
                    let filasHTML = '';
                    
                    productosConCantidad.forEach(producto => {
                        filasHTML += `
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" name="producto_id" value="${producto.id}" checked>
                                </td>
                                <td>${producto.nombre}</td>
                                <td>$${producto.precio.toFixed(2)}</td>
                                <td>
                                    <input type="number" name="cantidad" value="${producto.cantidad}" min="1" class="form-control" style="width:90px;">
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = filasHTML;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">
                                Este cliente no tiene compras anteriores
                            </td>
                        </tr>
                    `;
                }
            }
        });
    </script>

</body>
</html>