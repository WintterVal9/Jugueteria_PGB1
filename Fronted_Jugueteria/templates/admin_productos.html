{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrar Productos üé†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/admin.css' %}">
</head>

<body class="bg-light p-4">
  <header class="text-center mb-4">
    <h1>üé† Jugueter√≠a TeddyBear</h1>
    <p>M√≥dulo Administrativo - Gesti√≥n de Productos</p>
    <a href="/" class="btn btn-secondary mt-2">üè† Volver al Inicio</a>
  </header>

  <main class="container bg-white p-4 rounded shadow-sm">
    <h3 class="text-center mb-3">Agregar o Editar Producto</h3>
    <form id="productoForm" class="row g-3">
      <input type="hidden" id="id">
      <div class="col-md-6"><label class="form-label">C√≥digo</label><input type="text" id="codigo" class="form-control" required></div>
      <div class="col-md-6"><label class="form-label">Nombre</label><input type="text" id="nombre" class="form-control" required></div>
      <div class="col-md-4"><label class="form-label">Precio</label><input type="number" id="precio" class="form-control" step="0.01" required></div>
      <div class="col-md-4"><label class="form-label">Stock</label><input type="number" id="stock" class="form-control" required></div>
      <div class="col-md-4"><label class="form-label">L√≠nea</label><input type="text" id="linea" class="form-control"></div>
      <div class="col-12"><label class="form-label">Descripci√≥n</label><textarea id="descripcion" class="form-control" rows="3"></textarea></div>
      <div class="col-12 text-center mt-3">
        <button type="button" class="btn btn-success" onclick="guardarProducto()">üíæ Guardar Producto</button>
        <button type="button" class="btn btn-warning" onclick="document.getElementById('productoForm').reset()">üîÑ Limpiar</button>
      </div>
    </form>

    <hr class="my-4">

    <h3 class="text-center mb-3">Lista de Productos</h3>
    <div id="listaProductosAdmin"><p class="text-center">Cargando productos...</p></div>
  </main>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    async function guardarProducto() {
      try {
        const producto = {
          codigo: document.getElementById('codigo').value.trim(),
          nombre: document.getElementById('nombre').value.trim(),
          precio: document.getElementById('precio').value,
          stock: document.getElementById('stock').value,
          linea: document.getElementById('linea').value.trim(),
          descripcion: document.getElementById('descripcion').value.trim()
        };

        if (!producto.codigo || !producto.nombre || !producto.precio || !producto.stock) {
          alert('‚ö†Ô∏è Completa C√≥digo, Nombre, Precio y Stock');
          return;
        }

        const response = await fetch(`${API_BASE}/api/productos/`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(producto)
        });

        const resultado = await response.json();
        if (!response.ok) throw new Error(resultado.error || `Error ${response.status}`);

        document.getElementById('productoForm').reset();
        cargarProductosAdmin();
        alert('‚úÖ Producto guardado correctamente');

      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    async function cargarProductosAdmin() {
      try {
        const contenedor = document.getElementById('listaProductosAdmin');
        const response = await fetch(`${API_BASE}/api/productos/`);
        const productos = await response.json();

        if (!productos.length) {
          contenedor.innerHTML = '<div class="alert alert-info text-center"><p>üìù No hay productos registrados</p></div>';
          return;
        }

        contenedor.innerHTML = `
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="table-dark">
                <tr><th>C√≥digo</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>L√≠nea</th><th>Descripci√≥n</th></tr>
              </thead>
              <tbody>
                ${productos.map(p => `
                  <tr>
                    <td><strong>${p.codigo}</strong></td>
                    <td>${p.nombre}</td>
                    <td>$${p.precio}</td>
                    <td><span class="badge ${p.stock > 0 ? 'bg-success' : 'bg-danger'}">${p.stock}</span></td>
                    <td>${p.linea || '‚Äî'}</td>
                    <td>${p.descripcion || '‚Äî'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div class="text-center mt-3"><small class="text-muted">Mostrando ${productos.length} producto(s)</small></div>
        `;

      } catch (error) {
        document.getElementById('listaProductosAdmin').innerHTML = `
          <div class="alert alert-danger text-center"><p>‚ùå Error al cargar productos</p></div>
        `;
      }
    }

    // Cargar productos al iniciar
    document.addEventListener('DOMContentLoaded', cargarProductosAdmin);
  </script>
</body>
</html>